name: x4reader-release

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Build
        run: pio run

      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp .pio/build/esp32-c3-devkitm-1/firmware.bin dist/X4Reader.bin

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: X4Reader
          path: dist/X4Reader.bin

      - name: Compute next tag (0.1.x)
        id: next_tag
        uses: actions/github-script@v7
        with:
          script: |
            const tags = await github.paginate(github.rest.repos.listTags, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });
            const versions = tags
              .map(t => t.name)
              .filter(name => /^0\.1\.\d+$/.test(name))
              .map(name => Number(name.split('.')[2]))
              .filter(n => Number.isFinite(n));
            const nextPatch = versions.length ? Math.max(...versions) + 1 : 0;
            const nextTag = `0.1.${nextPatch}`;
            core.setOutput('tag', nextTag);

      - name: Create tag ref
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.next_tag.outputs.tag }}';
            const ref = `refs/tags/${tag}`;
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref,
              sha: process.env.GITHUB_SHA,
            });

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/X4Reader.bin
          tag_name: ${{ steps.next_tag.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.next_tag.outputs.tag }}
          generate_release_notes: false
